FROM node:latest

ARG YARN_OFFLINE

# Create app directory
RUN mkdir -p /usr/src/ride-minder-server
WORKDIR /usr/src/ride-minder-server

# Copy yarn from dev-cache to aid working offline
COPY ./dev-cache/yarn-latest /opt/yarn-latest
ENV PATH "/opt/yarn-latest/bin:$PATH"

# Install app dependencies, aided by a persistent cache
MOUNT ./dev-cache/yarn-cache:/root/.yarn-cache
MOUNT ./yarn.lock:/usr/src/ride-minder-server/yarn.lock
COPY package.json ./package.json
RUN yarn ${YARN_OFFLINE:+--offline}

# Bundle app source
COPY ./.babelrc /usr/src/ride-minder-server/
COPY ./src /usr/src/ride-minder-server/src

EXPOSE 3080
CMD ["yarn", "start"]

TAG ride-minder-graphql-server
